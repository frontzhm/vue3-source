# 5.  属性依赖收集和更新  -effect



<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525094015080.png" alt="image-20230525094015080" style="zoom:50%;" />

- Effect 函数
- 输入 ：回调函数
- 默认执行

创建响应式effect

<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525094235196.png" alt="image-20230525094235196" style="zoom:50%;" />

<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525094358461.png" alt="image-20230525094358461" style="zoom:50%;" />



属性怎么和方法关联起来



全局变量



<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525094508326.png" alt="image-20230525094508326" style="zoom:50%;" />



<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525094520836.png" alt="image-20230525094520836" style="zoom:50%;" />



<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525094618079.png" alt="image-20230525094618079" style="zoom:50%;" />

s先把自己放在外面，方便寻找。

取值的时候就找到了。

active

<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525094857884.png" alt="image-20230525094857884" style="zoom:50%;" />

取完值之后就清空

effect和属性的关系

 在执行effect的回调函数之前，将属性放到全局上，这样就能拿到对应的effect.



## 嵌套怎么办

<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525095111525.png" alt="image-20230525095111525" style="zoom:50%;" />

<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525095243752.png" alt="image-20230525095243752" style="zoom:50%;" />

早期用栈维护

  <img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525095403176.png" alt="image-20230525095403176" style="zoom:50%;" />

栈的最后一项

但这样需要用栈

现代的话，树结构，标记父子关系

<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525095630401.png" alt="image-20230525095630401" style="zoom:50%;" />

<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525095807623.png" alt="image-20230525095807623" style="zoom:50%;" />

这样始终能记录到parent

## 属性和effect关联

name 对应一个effect

age也是

<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525095950084.png" alt="image-20230525095950084" style="zoom:50%;" />



一个属性可以对应多个effect

一个effect可以多个属性

多对多

属性和effect产生关联关系

<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525100237157.png" alt="image-20230525100237157" style="zoom:50%;" />



帮你触发更新

先 取老值，在更新

<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525100419958.png" alt="image-20230525100419958" style="zoom:50%;" />



<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525100703686.png" alt="image-20230525100703686" style="zoom:50%;" />

有重复的不用重复

<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525100810183.png" alt="image-20230525100810183" style="zoom:50%;" />



<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525101154324.png" alt="image-20230525101154324" style="zoom:50%;" />



<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525101308150.png" alt="image-20230525101308150" style="zoom:50%;" />



<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525101322630.png" alt="image-20230525101322630" style="zoom:50%;" />



没有就添加，有就不添加

这样属性记住了effect

## effect 记住属性

<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525101637337.png" alt="image-20230525101637337" style="zoom:50%;" />



<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525101754263.png" alt="image-20230525101754263" style="zoom:50%;" />



dep是set ，记录依赖的set集合列表



![image-20230525101928201](/Users/zhm/Library/Application Support/typora-user-images/image-20230525101928201.png)

![image-20230525102002234](/Users/zhm/Library/Application Support/typora-user-images/image-20230525102002234.png)



<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525102257214.png" alt="image-20230525102257214" style="zoom:50%;" />



## 问题-死循环执行

 <img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525102406473.png" alt="image-20230525102406473" style="zoom:50%;" />



死循环 报错

加个判断

当前执行的effect如果是activeEffect 就不要执行

<img src="/Users/zhm/Library/Application Support/typora-user-images/image-20230525102533492.png" alt="image-20230525102533492" style="zoom:50%;" />













